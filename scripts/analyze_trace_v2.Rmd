---
title: "Parameter Inference Results"
subtitle: "Analysis Europe 10d"
author: "Cecilia Valenzuela"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  beamer_presentation:
    theme: "Pittsburgh"
    colortheme: "dove"
    fonttheme: "structurebold"
    highlight: pygments
classoption: "aspectratio=169"
fontsize: 8pt
tables: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(knitr.kable.NA = '')
```

```{r libraries}
# Load libraries ---------------------------------------------------------------
library(argparse)
library(yaml)
library(tidyverse)
library(lubridate)
library(scales)
# library(ggpubr)
library(ggsci)
# library(ggridges)
# library(patchwork)
# library(hrbrthemes)
# library(circlize)
# library(chorddiag) 
# library(ggforce)
# library(ComplexHeatmap)
# library(maps)
# library(sf)
# library(wpp2019)
# library(gridExtra)
# library(grid)
# Source files -----------------------------------------------------------------
source("./scripts/utils.R")
```

```{r parser}
# Parser -----------------------------------------------------------------------
parser <- argparse::ArgumentParser()
parser$add_argument("--diagnostic", type = "character", help="chains diagnostic file")
parser$add_argument("--trace", type = "character", help="trace file")
parser$add_argument("--trace_summary", type = "character", help="trace summary  file")
parser$add_argument("--burnin", type = "double", help = "Burning fraction for trajectory files")
parser$add_argument("--metadata", type = "character", help = "Alignment sequences metadata")
parser$add_argument("--demes", nargs = "+", help = "Demes configuration")
parser$add_argument("--analysis",  type = "character", help = "Analysis name")
parser$add_argument("--n", type = "integer", help = "Number of trajectories to analyze")
parser$add_argument("--output_figure", type = "character", help = "Output path for the figures")
parser$add_argument("--output_table", type = "character", help = "Output path for the tables")
args <- parser$parse_args()
```

```{r debugging}
# Debugging
args$burnin = 0.1
args$demes = read.csv("./files/demes_China.csv", stringsAsFactors = FALSE)
args$metadata =  "./results/europeC/final_metadata.tsv"
args$n = 200
demes = args$demes
demes$exclude_country[5] = "France,Germany,Italy,Spain"
#demes$deme[3] = "China"
#demes$division[3] = NA
demes <- demes %>% arrange(deme)
args$diagnostic = "/Users/maceci/Documents/CBB Master/HS20/Master Thesis/sars-cov-2-eu-phylodynamics/results/europeC/210129_europe10d_chains_diagnostic.txt"
args$trace = "/Users/maceci/Documents/CBB Master/HS20/Master Thesis/sars-cov-2-eu-phylodynamics/results/europeC/210129_europe10d_comb.log"
args$trace_summary = "/Users/maceci/Documents/CBB Master/HS20/Master Thesis/sars-cov-2-eu-phylodynamics/results/europeC/210129_europe10d_comb.summary.tsv"
```



```{r plotopts}
# Plot options -----------------------------------------------------------------------
set_plotopts()
#dcolors <- pal_npg("nrc")(10)[c(1:5,9)]
dcolors <- c("#E64B35FF", "#4DBBD5FF", "#00A087FF", "#3C5488FF", "#ffaa4fFF", "#7E6148FF")
# #dcolors <- c("#E64B35FF", "#7E6148FF", "#00A087FF", "#3C5488FF", "#4DBBD5FF", "#ffc954")
# #dcolors <- dcolors[1:nrow(demes)]
names(dcolors) <- sort(demes$deme)
# dark_dcolors <- rgb(t(col2rgb(dcolors)/2), maxColorValue=255)
# names(dark_dcolors) <- names(dcolors)
# ecolors <- c(B = "#1e3d59", M = "#f5f0e1", IM = "#ff6e40", OM = "#ffc13b")
colors = viridis_pal()(10)
```


## Deme configuration
\tiny
```{r demeconfig}
# Load demes configuration and sequence metadata -------------------------------
# demes <- data.frame(deme = NA, region = NA, country = NA, division = NA, 
#                     exclude_country = NA, exclude_division = NA,
#                     min_date = NA, max_date = NA, seq_per_deme = NA) %>%
#   bind_rows(bind_rows(lapply(yaml::yaml.load(string = paste(args$demes, collapse = " ")),
#                           data.frame, stringsAsFactors = FALSE), .id = "deme")) %>%
#   group_by(deme) %>% 
#   mutate(exclude_country = ifelse(is.na(exclude_country), NA, paste0(exclude_country, collapse = ","))) %>%
#   distinct() %>%
#   filter_all(any_vars(!is.na(.))) %>%
#   mutate(deme = str_to_title(deme)) %>%
#   mutate(deme = ifelse(deme %in% c("Othereuropean", "OtherEuropean"), "Other European", deme))
# 
china_deme <- demes$deme[demes$region == "Asia"]
if (china_deme == "Hubei-China") china_deme = "China"

knitr::kable(demes)
```


```{r}
# Read files ------------------------------------------------------------------
analysis <- gsub("_comb.log", "", tail(str_split(args$trace, "/")[[1]], 1))
analysis_specs <- read_tsv("analyses/analyses_specs.tsv") %>%
  select(1:4, analysis)

diagnostic <- read_table2(args$diagnostic)
trace <- read_trace(args$trace, burninFrac = 0)
trace_summary <- read_table(args$trace_summary)

first_sample <- analysis_specs %>%
  filter(input == "firstSample") %>%
  pull(analysis)

last_sample <- analysis_specs %>%
  filter(input == "mostRecentSampleTime") %>%
  pull(analysis)
```

## Chains diagnostic

```{r diagnostic}
knitr::kable(diagnostic)
```

## Convergence

- **Mean ESS value:** `r mean(trace_summary$ESS, na.rm = TRUE)`
- **Median ESS value:** `r median(trace_summary$ESS, na.rm = TRUE)`
- **Standard deviation ESS value:** `r sd(trace_summary$ESS, na.rm = TRUE)`

```{r convergence, fig.height=4.5}
trace %>%
  pivot_longer(-Sample, names_to = "param", values_to = "value") %>%
  filter(param %in% c("posterior", "prior", "treeLikelihood")) %>%
  ggplot() +
  geom_line(aes(x = Sample, y = value, color = param), alpha = 0.5) +
  facet_wrap(~param, ncol = 1, scales = "free") +
  scale_color_viridis_d() +
  theme(legend.position = "none")


stats <- trace_summary %>%
  filter(item %in%  c("posterior", "prior", "treeLikelihood")) %>%
  select(5:7, ESS)
knitr::kable(stats)
```

## TreeHeight

**First sample date:** `r first_sample`

```{r treeheight2, fig.height=3}
param = "TreeHeight"

ggplot(trace) +
  geom_density(aes_string(param), color = colors[1], fill = colors[1], alpha = 0.3) +
  scale_x_continuous(labels = to_date(seq(0,1,0.01), mrs = last_sample), breaks = seq(0,1,0.01)) +
  theme(axis.text = element_text(angle=270))

stats <- trace_summary %>%
  filter(item == param) %>%
  mutate(median = to_date(median, mrs = last_sample),
         `95%HPDlo` = to_date(`95%HPDlo`, mrs = last_sample),
         `95%HPDup` = to_date(`95%HPDup`, mrs = last_sample)) %>%
  select(5:7, ESS)
knitr::kable(stats)

```


## gammaShape

```{r gammaShapePrior}
param = "gammaShape"
prior <- analysis_specs %>%
  filter(BEASTtag == "Prior", BEASTobject == param) 
```

**Prior:** `r t(prior %>% pull(analysis))`


```{r gammaShapePosterior, fig.height=3}
ggplot(trace) +
  geom_density(aes_string(param), color = colors[2], fill = colors[2], alpha = 0.3) +
  stat_function(aes(x = seq(0,0.8)), fun = function(x) dexp(x, 2), linetype = 2)

stats <- trace_summary %>%
  filter(item == param) %>%
  select(5:7, ESS)
knitr::kable(stats)
```


## kappa

```{r kappaPrior}
param = "kappa"
prior <- analysis_specs %>%
  filter(BEASTtag == "Prior", BEASTobject == param)
```

**Prior:** `r t(prior %>% pull(analysis))`

```{r kappaPosterior, fig.height=3}
ggplot(trace) +
  geom_density(aes_string(param), color = colors[3], fill = colors[3], alpha = 0.3) +
  stat_function(aes(x = seq(0,0.8)), fun = function(x) dlnorm(x, 
                                                              meanlog = as.numeric(prior %>% filter(input == "M") %>% pull(analysis)),
                                                              sdlog = as.numeric(prior %>% filter(input == "S") %>% pull(analysis))), 
                linetype = 2)

stats <- trace_summary %>%
  filter(item == param) %>%
  select(5:7, ESS)
knitr::kable(stats)
```

## originBDMMPrime

```{r originBDMMPrimePrior}
param = "originBDMMPrime"
prior <- analysis_specs %>%
  filter(BEASTtag == "Prior", BEASTobject == param)
```

**Prior:** `r t(prior %>% pull(analysis))`

```{r originBDMMPrimePosterior, fig.height=3}
ggplot(trace) +
  geom_density(aes_string(param), color = colors[4], fill = colors[4], alpha = 0.3) +
  stat_function(aes(x = seq(0.2,1)), fun = function(x) dlnorm(x,
                                                              meanlog = as.numeric(prior %>% filter(input == "M") %>% pull(analysis)),
                                                              sdlog = as.numeric(prior %>% filter(input == "S") %>% pull(analysis))),
                linetype = 2) +
  scale_x_continuous(limits = c(0.2, 0.6), labels = to_date(seq(0,1,0.01), mrs = last_sample), breaks = seq(0,1,0.01)) +
  theme(axis.text = element_text(angle=270))

stats <- trace_summary %>%
  filter(item == param) %>%
  mutate(median = to_date(median, mrs = last_sample),
         `95%HPDlo` = to_date(`95%HPDlo`, mrs = last_sample),
         `95%HPDup` = to_date(`95%HPDup`, mrs = last_sample)) %>%
  select(5:7, ESS)
knitr::kable(stats)
```

## R0

```{r R0Prior}
param = "R0"
prior <- analysis_specs %>%
  filter(BEASTtag == "Prior", BEASTobject == param, input != "Spec")
```

**Prior:** `r t(prior %>% pull(analysis))`

```{r R0Posterior, fig.height=5}
posterior <- trace %>%
  select(Sample, contains(param)) %>%
  pivot_longer(-Sample, names_to = "param", values_to = "value") %>%
  separate(param, into = c("param", "deme"), "SV") %>%
  separate(deme, into = c("epoch", "deme"), "_", fill = "left") %>%
  filter(deme != "endtime")
  

ggplot(posterior) +
  geom_density(aes(value, color = deme, fill = deme), alpha = 0.3) +
  facet_wrap(~epoch, scales = "free", ncol = 1) +
  scale_color_manual(values = dcolors) +
  scale_fill_manual(values = dcolors) +
  stat_function(aes(x = seq(0,0.8)), 
                fun = function(x) dlnorm(x, meanlog = as.numeric(prior %>% filter(input == "M") %>% pull(analysis)),
                                         sdlog = as.numeric(prior %>% filter(input == "S") %>% pull(analysis))), 
                linetype = 2)
```

## R0
```{r R0 stats}
stats <- trace_summary %>%
  filter(grepl(param, item),!grepl("endtime", item), !grepl("Among", item)) %>%
  select(item, mean, 5:7, ESS)
knitr::kable(stats)
```


## becomeUninfectiousRate
Fixed to 36.5 year^-1^ (time exponentially distributed mean 10 days)


## samplingProportion

```{r samplingProportionPrior}
param = "samplingProportion"
prior <- analysis_specs %>%
  filter(BEASTtag == "Prior", BEASTobject == param, input != "Spec")
```

**Prior:** `r knitr::kable(prior %>% select(input, deme, analysis))`

## samplingProportion

```{r samplingProportionPosterior, fig.height=5}
posterior <- trace %>%
  select(Sample, contains(param)) %>%
  pivot_longer(-Sample, names_to = "param", values_to = "value") %>%
  separate(param, into = c("param", "deme"), "SV") %>%
  separate(deme, into = c("epoch", "deme"), "_", fill = "left") %>%
  filter(deme != "endtime")
  
ggplot(posterior) +
  geom_density(aes(value, color = deme, fill = deme), alpha = 0.3) +
  facet_wrap(~epoch, scales = "free", ncol = 1) +
  scale_color_manual(values = dcolors) +
  scale_fill_manual(values = dcolors) +
  stat_function(aes(x = seq(0,0.8)), 
                fun = function(x) dlnorm(x, meanlog = as.numeric(prior %>% filter(input == "M") %>% pull(analysis)),
                                         sdlog = as.numeric(prior %>% filter(input == "S") %>% pull(analysis))), 
                linetype = 2)
```

## samplingProportion
```{r samplingProportion stats}
stats <- trace_summary %>%
  filter(grepl(param, item),!grepl("endtime", item), !grepl("Among", item)) %>%
  select(item, mean, 5:7, ESS)
knitr::kable(stats)
```


## removalProb
Fixed to 1.


## migrationRate China

```{r migrationRatePrior}
param = "migrationRate"
prior <- analysis_specs %>%
  filter(BEASTtag == "Prior", BEASTobject == param)
```

**Prior:** `r t(prior %>% pull(analysis))`

```{r migrationRatePosterior, fig.height=3}
posterior <- trace %>%
  select(Sample, contains(param)) %>%
  pivot_longer(-Sample, names_to = "param", values_to = "value") %>%
  separate(param, into = c("param", "mig"), "SM") %>%
  separate(mig, into = c("src", "dest"), "_to_") %>%
  separate(src, into = c("epoch", "src"), "_", fill = "left") %>%
  filter(!is.na(dest))
```

\tiny
```{r migrationRateChina, fig.height=2.5}
ggplot(posterior %>% filter(src == "China")) +
  geom_density(aes(value, color = dest, fill = dest), alpha = 0.3) +
  facet_grid(~epoch) +
  coord_cartesian(xlim = c(0,0.3), ylim = c(0,20)) +
  scale_color_manual(values = dcolors) +
  scale_fill_manual(values = dcolors) +
  stat_function(aes(x = seq(0,0.8)), 
                fun = function(x) dlnorm(x, meanlog = as.numeric(prior %>% filter(input == "M") %>% pull(analysis)),
                                         sdlog = as.numeric(prior %>% filter(input == "S") %>% pull(analysis))), 
                linetype = 2) +
  theme(legend.position = "right")
  
stats <- trace_summary %>%
  filter(grepl(param, item),!grepl("endtime", item), grepl("China_to", item)) %>%
  select(item, mean, 5:7, ESS)
knitr::kable(stats)
```

## migrationRate France

**Prior:** `r t(prior %>% pull(analysis))`

\tiny
```{r migrationRateFrance, fig.height=2.5}
ggplot(posterior %>% filter(src == "France")) +
  geom_density(aes(value, color = dest, fill = dest), alpha = 0.3) +
  facet_grid(~epoch) +
  coord_cartesian(xlim = c(0,5), ylim = c(0,20)) +
  scale_color_manual(values = dcolors) +
  scale_fill_manual(values = dcolors) +
  stat_function(aes(x = seq(0,0.8)), 
                fun = function(x) dlnorm(x, meanlog = as.numeric(prior %>% filter(input == "M") %>% pull(analysis)),
                                         sdlog = as.numeric(prior %>% filter(input == "S") %>% pull(analysis))), 
                linetype = 2) +
  theme(legend.position = "right")
  
stats <- trace_summary %>%
  filter(grepl(param, item),!grepl("endtime", item), grepl("France_to", item)) %>%
  select(item, mean, 5:7, ESS)
knitr::kable(stats)
```

## migrationRate Germany

**Prior:** `r t(prior %>% pull(analysis))`

\tiny
```{r migrationRateGermany, fig.height=2.5}
ggplot(posterior %>% filter(src == "Germany")) +
  geom_density(aes(value, color = dest, fill = dest), alpha = 0.3) +
  facet_grid(~epoch, scales = "free") +
  coord_cartesian(xlim = c(0,5), ylim = c(0,30)) +
  scale_color_manual(values = dcolors) +
  scale_fill_manual(values = dcolors) +
  stat_function(aes(x = seq(0,0.8)), 
                fun = function(x) dlnorm(x, meanlog = as.numeric(prior %>% filter(input == "M") %>% pull(analysis)),
                                         sdlog = as.numeric(prior %>% filter(input == "S") %>% pull(analysis))), 
                linetype = 2) +
  theme(legend.position = "right")
  
stats <- trace_summary %>%
  filter(grepl(param, item),!grepl("endtime", item), grepl("Germany_to", item)) %>%
  select(item, mean, 5:7, ESS)
knitr::kable(stats)
```

## migrationRate Italy

**Prior:** `r t(prior %>% pull(analysis))`

\tiny
```{r migrationRateItaly, fig.height=2.5}
ggplot(posterior %>% filter(src == "Italy")) +
  geom_density(aes(value, color = dest, fill = dest), alpha = 0.3) +
  facet_grid(~epoch) +
  coord_cartesian(xlim = c(0,5), ylim = c(0,30)) +
  scale_color_manual(values = dcolors) +
  scale_fill_manual(values = dcolors) +
  stat_function(aes(x = seq(0,0.8)), 
                fun = function(x) dlnorm(x, meanlog = as.numeric(prior %>% filter(input == "M") %>% pull(analysis)),
                                         sdlog = as.numeric(prior %>% filter(input == "S") %>% pull(analysis))), 
                linetype = 2) +
  theme(legend.position = "right")
  
stats <- trace_summary %>%
  filter(grepl(param, item),!grepl("endtime", item), grepl("Italy_to", item)) %>%
  select(item, mean, 5:7, ESS)
knitr::kable(stats)
```

## migrationRate Other European

**Prior:** `r t(prior %>% pull(analysis))`

\tiny
```{r migrationRateOtherEuropean, fig.height=2.5}
ggplot(posterior %>% filter(src == "OtherEuropean")) +
  geom_density(aes(value, color = dest, fill = dest), alpha = 0.3) +
  facet_grid(~epoch) +
  coord_cartesian(xlim = c(0,20), ylim = c(0,30)) +
  scale_color_manual(values = dcolors) +
  scale_fill_manual(values = dcolors) +
  stat_function(aes(x = seq(0,0.8)), 
                fun = function(x) dlnorm(x, meanlog = as.numeric(prior %>% filter(input == "M") %>% pull(analysis)),
                                         sdlog = as.numeric(prior %>% filter(input == "S") %>% pull(analysis))), 
                linetype = 2) +
  theme(legend.position = "right")
  
stats <- trace_summary %>%
  filter(grepl(param, item),!grepl("endtime", item), grepl("OtherEuropean_to", item)) %>%
  select(item, mean, 5:7, ESS)
knitr::kable(stats)
```

## migrationRate Spain

**Prior:** `r t(prior %>% pull(analysis))`

\tiny
```{r migrationRateSpain, fig.height=2.5}
ggplot(posterior %>% filter(src == "Spain")) +
  geom_density(aes(value, color = dest, fill = dest), alpha = 0.3) +
  facet_grid(~epoch) +
  coord_cartesian(xlim = c(0,5), ylim = c(0,40)) +
  scale_color_manual(values = dcolors) +
  scale_fill_manual(values = dcolors) +
  stat_function(aes(x = seq(0,0.8)), 
                fun = function(x) dlnorm(x, meanlog = as.numeric(prior %>% filter(input == "M") %>% pull(analysis)),
                                         sdlog = as.numeric(prior %>% filter(input == "S") %>% pull(analysis))), 
                linetype = 2) +
  theme(legend.position = "right")
  
stats <- trace_summary %>%
  filter(grepl(param, item),!grepl("endtime", item), grepl("Spain_to", item)) %>%
  select(item, mean, 5:7, ESS)
knitr::kable(stats)
```

## scalerParamGLM

```{r scalerParamPrior}
param = "scalerParamGLM"
prior <- analysis_specs %>%
  filter(BEASTtag == "Prior", grepl(param, BEASTobject))
```

**Prior:** `r t(prior %>% pull(analysis))`

```{r scalerParamPosterior, fig.height=3}
posterior <- trace %>%
  select(Sample, contains(param) & !contains("global")) %>%
  pivot_longer(-Sample, names_to = "param", values_to = "value")
  

ggplot(posterior) +
  geom_density(aes(value, color = param, fill = param), alpha = 0.3) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  stat_function(aes(x = seq(0,0.8)), 
                fun = function(x) dnorm(x, mean = as.numeric(prior %>% filter(input == "Mean") %>% pull(analysis)),
                                         sd = as.numeric(prior %>% filter(input == "Sigma") %>% pull(analysis))), 
                linetype = 2)

stats <- trace_summary %>%
  filter(grepl(param, item),!grepl("endtime", item), !grepl("Among", item)) %>%
  select(item, mean, 5:7, ESS)
knitr::kable(stats)

```



## globalScalerParamGLM

```{r globalScalerParamPrior}
param = "globalScalerParamGLM"
prior <- analysis_specs %>%
  filter(BEASTtag == "Prior", BEASTobject == param)
```

**Prior:** `r t(prior %>% pull(analysis))`

```{r globalScalerParamPosterior, fig.height=3}
ggplot(trace) +
  geom_density(aes_string(param), color = colors[3], fill = colors[3], alpha = 0.3) +
  stat_function(aes(x = seq(0,0.8)), fun = function(x) dlnorm(x, 
                                                              meanlog = as.numeric(prior %>% filter(input == "M") %>% pull(analysis)),
                                                              sdlog = as.numeric(prior %>% filter(input == "S") %>% pull(analysis))), 
                linetype = 2)

stats <- trace_summary %>%
  filter(item == param) %>%
  select(5:7, ESS)
knitr::kable(stats)
```

## indicatorParamGLM

<!-- Fixed to included. -->

```{r indicatorParamGLM}
param = "indicatorParamGLM"
initial_value <- analysis_specs %>%
  filter(BEASTtag == "State", BEASTobject == param)

stats <- trace_summary %>%
  filter(grepl(param, item)) %>%
  select(item, mean, 5:7, ESS)
```

- **Initial value:** `r t(initial_value %>% pull(analysis))`
- **Inclusion probability:** `r stats %>% pull(mean)`



