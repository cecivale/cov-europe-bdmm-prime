---
title: "Trajectory Mapping Results"
author: "Cecilia Valenzuela"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  beamer_presentation:
    theme: "Pittsburgh"
    colortheme: "dove"
    fonttheme: "structurebold"
    highlight: pygments
classoption: "aspectratio=169"
fontsize: 8pt
tables: yes
---

```{r parser, echo = FALSE}
library(tidyverse)
# Parser -----------------------------------------------------------------------
argsR <- commandArgs(TRUE)
args_list <- str_split(paste(argsR, collapse=""), pattern="--")
args_llist <- lapply(args_list, function(x) str_split(x, pattern="="))
argsDF <- as.data.frame(do.call("rbind", args_llist[[1]]))
args <- as.list(as.character(argsDF$V2))
names(args) <- argsDF$V1
args$burnin <- as.integer(args$burnin)
args$n <- as.integer(args$n)
title <- paste("Analysis", gsub("\\.", " ", gsub(".TL.traj", " particles", str_split(args$args, "/")[[1]][3])))
```

---
subtitle: "`r title`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(knitr.kable.NA = '')
```

```{r libraries, results='hide', message=FALSE, warning=FALSE}
# Load libraries ---------------------------------------------------------------
library(yaml)
library(lubridate)
library(scales)
library(ggpubr)
library(ggsci)
library(ggridges)
library(patchwork)
library(hrbrthemes)
library(circlize)
library(chorddiag) 
library(ggforce)
#library(ComplexHeatmap)
library(maps)
library(sf)
library(wpp2019)
library(gridExtra)
library(grid)
# Source files -----------------------------------------------------------------
source("./scripts/trajProcessing.R")
source("./scripts/utils.R")
source("./scripts/flight_data.R")
```


```{r debugging}
# Debugging
# args = list()
# args$burnin = 0.1
# args$demes = read.csv("./files/demes_China.csv", stringsAsFactors = FALSE)
# args$args = "/Users/maceci/europe10last/210205_europe10.10000.TL.traj"
# args$metadata =  "./results/europeC/final_metadata.tsv"
# args$n = 10
# demes = args$demes
# demes$exclude_country[5] = "France,Germany,Italy,Spain"
# demes <- demes %>% arrange(deme)
```


## Deme configuration
\tiny
```{r demeconfig}
# Load demes configuration and sequence metadata -------------------------------
demes <- data.frame(deme = NA, region = NA, country = NA, division = NA,
                    exclude_country = NA, exclude_division = NA,
                    min_date = NA, max_date = NA, seq_per_deme = NA) %>%
  bind_rows(bind_rows(lapply(yaml::yaml.load(string = gsub(",", ", ", gsub(":", ": ", args$demes))),
                          data.frame, stringsAsFactors = FALSE), .id = "deme")) %>%
  group_by(deme) %>%
  mutate(exclude_country = ifelse(is.na(exclude_country), NA, paste0(exclude_country, collapse = ","))) %>%
  distinct() %>%
  filter_all(any_vars(!is.na(.))) %>%
  mutate(deme = str_to_title(deme)) %>%
  mutate(deme = ifelse(deme %in% c("Othereuropean", "OtherEuropean"), "Other European", deme)) %>%
  arrange(deme)

china_deme <- demes$deme[demes$region == "Asia"]
if (china_deme == "Hubei-China") china_deme = "China"
```

```{r plotopts}
# Plot options -----------------------------------------------------------------------
set_plotopts()
dcolors <- pal_npg("nrc")(10)[c(1:5,9)]
dcolors <- c("#E64B35FF", "#4DBBD5FF", "#00A087FF", "#3C5488FF", "#ffaa4fFF", "#7E6148FF")
#dcolors <- c("#E64B35FF", "#7E6148FF", "#00A087FF", "#3C5488FF", "#4DBBD5FF", "#ffc954")
#dcolors <- dcolors[1:nrow(demes)]
names(dcolors) <- sort(demes$deme)
dark_dcolors <- rgb(t(col2rgb(dcolors)/2), maxColorValue=255)
names(dark_dcolors) <- names(dcolors)
ecolors <- c(B = "#1e3d59", M = "#f5f0e1", IM = "#ff6e40", OM = "#ffc13b")
```


```{r map, fig.height=2, fig.align="center"}
plot_map(demes)
knitr::kable(demes %>% select(-c("exclude_division", "prob")), booktabs = TRUE)
```


## ECDC Case count data

```{r ecdc-data, results='hide'}
# Case data information from ECDC ----------------------------------------------
# Most recent sample value
metadata <- read_tsv(args$metadata)
MRS <- max(metadata$date)
mrs <- ymd_hms(paste(MRS, '23:59:00 UTC'))

case_data <- get_cases(demes, from = ymd("2019-09-01"), to = MRS) 
```

::: {.columns}

:::: {.column width="40%"}
\small
```{r ecdc-table, echo=FALSE}
knitr::kable(case_data %>% filter(date == MRS) %>% select(deme, source, total_confirmed)%>% pivot_wider(names_from = "source", values_from = total_confirmed) %>% mutate_if(is.numeric, function (x) round(x,1)), booktabs = TRUE, caption = paste("Total number of cases reported to ECDC on March 8, 2020"))
```
::::
  
:::: {.column width="60%"}
```{r ecdc-plot, fig.height = 3, fig.width=4, fig.cap="ECDC case counts for each deme from the beginning of the pandemic to March 8, 2020"}

ggplot(case_data %>% filter(source == "ecdc")) +
  geom_line(aes(x = date, y = total_confirmed, color = deme)) +
  geom_point(aes(x = date, y = total_confirmed, color = deme)) +
  #facet_wrap(~source) +
  scale_color_manual(values = dcolors, name = "") +
  scale_x_date(limits = c(ymd("2019-12-30"), ymd("2020-03-18")), date_breaks = "1 month", date_labels = "%b %d") +
  scale_y_log10(labels = trans_format("log10", math_format(10^.x))) +
  ylab("Total confirmed cases") +
  theme(axis.title.x=element_blank(),
        legend.position = c(0.2, 0.7),
        legend.box="horizontal",
        panel.grid.major.y =  element_line(colour = "grey80", size = 0.3, linetype = 2),
        panel.grid.minor.y =  element_line(colour = "grey80", size = 0.2,  linetype = 2),
        panel.background =  element_blank())
```

::::
  
:::
  
## Epidemic trajectory data
  
  From the Stochastic Trajectory Mapping analysis, we sample with importance sampling one epidemic trajectory per set of parameters + typed node tree from the set of simulated trajectories.

The processing of the trajectory data includes the generation of two different datasets:
  
  - `states`: We have the total number of inferred cases by trajectory, deme and time.
- `events`: We have each event that happened in a epidemic trajectory, with its type (origin, birth, death or migration), the source/destination deme and time.

## Epidemic trajectory data

We use the events dataset to compute quantities of interest:
  
  - `B`: transmissions (births) events 
- `D`: becoming unifectious (deaths) events
- `IM`: migrations into the deme 
- `OM`: migrations out of the deme
- `S`: sampling events
- `O`: origin
- `in_pop`: origin + transmissions + incoming migrations 
- `out_pop`: deaths + outgoing migration + sampling events
- `active_pop`: origin + transmissions + incoming migrations - (deaths + outgoing migration + sampling events)

```{r traj-data, warnings = FALSE, message = FALSE, cache = FALSE}
# Load trajectory data ---------------------------------------------------------
df <- loadTrajectories(args$args, burninFrac = args$burnin, subsample = args$n)

# Data wrangling ---------------------------------------------------------------
df_traj <- processEvents(df$events, demes, "China", MRS)
```


## Epidemic trajectory data

```{r table-events}
knitr::kable(head(df_traj %>% filter(value != 0), 5), booktabs = TRUE, caption = "Trajectories dataset")
```

\normalsize
To have a feasible time of analysis of the epidemic trajectories we take a random subsample of 500 trajectories.

To facilitate visualization and summarise the results, we take a grid time of 1 day and summarise the number of events that day as the sum of the events in the corresponding time interval; and the number of inferred cases as the maximum of the interval.

```{r traj-processing}
# Add reported case counts
df_traj_cases <- df_traj %>%
  mutate(traj = as.character(traj)) %>%
  bind_rows(case_data %>%
              mutate(var = source, value = new_confirmed, cumvalue = total_confirmed) %>%
              select(deme, var, date, value, cumvalue))

# Summarise trajectories, compute mean, median and 95% HPD interval for each variable
traj_summary <- df_traj %>%
  group_by(var, deme, partner, date) %>%
  summarise(l95_value = HDInterval::hdi(value)[[1]],
            h95_value = HDInterval::hdi(value)[[2]],
            median_value = median(value),
            mean_value = mean(value),
            l95_cumvalue = HDInterval::hdi(cumvalue)[[1]],
            h95_cumvalue = HDInterval::hdi(cumvalue)[[2]],
            #l95_cumvalue = quantile(cumvalue, 0.025),
            #h95_cumvalue = quantile(cumvalue, 0.975),
            median_cumvalue = median(cumvalue),
            mean_cumvalue = mean(cumvalue)) %>% ungroup

```

```{r}
# 1. Total 
# 1.1 Median and 95% CCI of Total cases on the full time period. Fraction median
#    and 95% CCI (cases ecdc/inferred cases) wrt. ECDC reported cases

# Total values March 8, 2020 join with reported cases
traj_total <- traj_summary %>%
  filter(date == MRS) %>%
  select(var, date, deme, partner, matches("cumvalue"))  %>%
  left_join(case_data %>% filter(source == "ecdc")) %>%
  select(var, deme, matches("cumvalue"), total_confirmed) %>%
  mutate(ltimes = l95_cumvalue/total_confirmed,
         htimes = h95_cumvalue/total_confirmed,
         mtimes = median_cumvalue/total_confirmed) %>%
  mutate_if(is.numeric, function(x) round(x,2)) 

#knitr::kable(t(traj_total %>% filter(var == "D"))[-1,])
```

## Origin of SARS-CoV-2 in Europe

```{r first-eu, fig.height=4}
first_df1 <- df_traj %>%
  # 1. Prepare data
  filter(var == "IM", !is.na(partner),  value != 0) %>%
  group_by(traj) %>%
  arrange(date, partner) %>%
  slice(1)

first_ecdc <- case_data %>% 
  filter(source == "ecdc", total_confirmed != 0) %>% 
  group_by(deme) %>% 
  arrange(date) %>% 
  slice(1) %>%
  ungroup()
 
first_eui <- first_df1 %>% 
  ggplot(aes(date)) +
  geom_density(aes(y = ..count..), fill = "grey", alpha = .5, col = NA, bw = 2) + 
  geom_histogram(binwidth = 1, alpha = .5, fill = "#21908CFF", color = "#21908CFF") +
  geom_vline(aes(xintercept = median(first_df1$date), linetype = "first case median infered date")) +
  geom_vline(aes(xintercept = min((first_ecdc %>% filter(deme != "China"))$date), linetype = "first confirmed case to ECDC")) +
  ylab("epidemic trajectory count") +
  scale_x_date(limits = c(ymd("2019-12-15"), ymd("2020-02-01")), date_breaks = "1 week", date_labels = "%b %d, %Y", expand = c(0,0)) +
  scale_linetype_manual(name = "", values = c(1,2)) +
  theme(axis.title.x = element_blank()) 

first_euii <- first_df1 %>% 
  ggplot(aes(date)) +
  geom_density(fill = "grey", alpha = .5, col = NA, bw = 2) + 
  geom_histogram(binwidth = 1, alpha = .5, fill = "#21908CFF", color = "#21908CFF", aes( y = ..density..)) +
  geom_vline(aes(xintercept = median(first_df1$date), linetype = "first case median infered date")) +
  geom_vline(aes(xintercept = min((first_ecdc %>% filter(deme != "China"))$date), linetype = "first confirmed case to ECDC")) +
  ylab("probability density") +
  scale_y_continuous(position = "right") +
  scale_x_date(limits = c(ymd("2019-12-15"), ymd("2020-02-01")), date_breaks = "1 week", date_labels = "%b %d, %Y", expand = c(0,0)) +
  scale_linetype_manual(name = "", values = c(1,2)) +
  theme(axis.title.x = element_blank())

first_eui

ggexport(first_eui,
         filename = paste0(args$output_figure, "01i.png"),
         width = 2100, height = 800, res = 300)
ggexport(first_euii,
         filename = paste0(args$output_figure, "01ii.png"),
         width = 2100, height = 800, res = 300)
```

*Median date:* `r median(first_df1$date)`\
*95% CCI:* (`r quantile(first_df1$date, 0.025, type = 1)`, `r quantile(first_df1$date, 0.975, type = 1)`)\
*ECDC first confirmed case:* `r min((first_ecdc %>% filter(deme != "China"))$date)`\

## First imported cases to Europe, time and location
```{r first-eu-destsrc, fig.height=4}
# 2.2b First introduction to Europe, distribution density destination
facet_names <- demes$deme
names(facet_names) <- demes$deme
facet_names["OtherEuropean"] <- "Other EU"

first_eu1d <- ggplot(first_df1, aes(x = date, y = ..count../(args$n))) +
  geom_density_line(
    data = select(first_df1, -deme), aes(fill = NA),
    color = "transparent", alpha = 0.8, bw = 2) + 
  geom_density_line(aes(fill = deme), bw = 2, color = "transparent", alpha = 0.8) +
  facet_grid(rows = vars(deme), switch = "y", drop = FALSE,
             labeller = labeller(deme = facet_names)) +
  scale_fill_manual(name = "", values = dcolors, na.value = "grey") +
  scale_x_date(limits = c(ymd("2020-01-01"), ymd("2020-02-15")), date_breaks = "1 week", date_labels = "%b %d, %Y", expand = c(0,0)) +
  ylab("probability density by destination country") +
  xlab("date") +
  labs(title = "First imported case to Europe, \ndestination") +
  theme(legend.position = "none",
        axis.title.x=element_blank())

# 2.2b First 10 introduction to Europe, distribution density destination
m = 10
first_df10 <- df_traj %>%
  # 1. Prepare data
  filter(var == "IM", !is.na(partner),  value != 0) %>%
  group_by(traj) %>%
  arrange(date, partner) %>%
  slice(1:m)

first_eu10d <- ggplot(first_df10, aes(x = date, y = ..count../(m*args$n))) +
  geom_density_line(
    data = select(first_df10, -deme), aes(fill = NA),
    color = "transparent", alpha = 0.8, bw = 2) + 
  geom_density_line(aes(fill = deme), bw = 2, color = "transparent", alpha = 0.8) +
  facet_grid(rows = vars(deme), switch = "y", drop = FALSE, labeller = labeller(deme = facet_names)) +
  scale_fill_manual(name = "", values = dcolors, na.value = "grey") +
  scale_x_date(limits = c(ymd("2020-01-01"), ymd("2020-02-15")), date_breaks = "1 week", date_labels = "%b %d, %Y", expand = c(0,0)) +
  ylab("probability density by destination country") +
  xlab("date") +
  labs(title = "First 10 imported cases to Europe, \ndestination") +
  theme(legend.position = "none",
        axis.title.x=element_blank())

first_eu10s <- ggplot(first_df10, aes(x = date, y = ..count../(m*args$n))) +
  geom_density_line(
    data = select(first_df10, -partner), aes(fill = NA),
    color = "transparent", alpha = 0.8, bw = 2) + 
  geom_density_line(aes(fill = partner), bw = 2, color = "transparent", alpha = 0.8) +
  facet_grid(rows = vars(partner), switch = "y", drop = FALSE, labeller = labeller(partner = facet_names)) +
  scale_fill_manual(name = "", values = dcolors, na.value = "grey") +
  scale_x_date(limits = c(ymd("2020-01-01"), ymd("2020-02-15")), date_breaks = "1 week", date_labels = "%b %d, %Y", expand = c(0,0)) +
  ylab("probability density by source country") +
  xlab("date") +
  labs(title = "First 10 imported cases to Europe, \nsource") +
  theme(legend.position = "none",
        axis.title.x=element_blank())

first_eu_ds <- ggarrange(first_eu1d, first_eu10d, first_eu10s, labels = chartr("123456789", "ABCDEFGHI", 1:3), font.label = list(size = 9), nrow = 1, ncol = 3, hjust = -6, vjust = 2)
first_eu_ds
ggexport(first_eu_ds,
         filename = paste0(args$output_figure, "02.png"),
         width = 2500, height = 1500, res = 300)

```

## First imported cases to Europe, time and location
```{r first-eu-table}
knitr::kable(first_df1 %>%
               ungroup %>%
               count(deme, name = "n_1d") %>%
               mutate(p_1d = n_1d/args$n) %>%
               left_join(first_df10 %>%
                           ungroup %>%
                           count(deme,  name = "n_10d") %>%
                           mutate(p_10d = n_10d/(10*args$n)) %>%
                           left_join(first_df10 %>%
                                       ungroup %>%
                                       select(-deme) %>% rename(deme = partner) %>%
                                       count(deme,  name = "n_10s") %>%
                                       mutate(p_10s = n_10s/(10*args$n)))))
```

## First introductions to each country, source

```{r first-bycountry, fig.height=4}
# 2.2b First introduction into each country, distribution density destination
m = 1
first_country <- df_traj %>%
  mutate(partner = ifelse(var == "O", "China", partner)) %>%
  # 1. Prepare data
  filter(var == "IM" & deme != "China"| var == "O" & deme == "China", !is.na(partner), value != 0) %>%
  group_by(traj, deme) %>%
  arrange(date, partner) %>%
  slice(1:m)

first_countryplot <- ggplot(first_country, aes(x = date, y = ..count../(m*args$n))) +
  geom_density_line(
    data = select(first_country, -deme), aes(fill = NA),
    color = "transparent", alpha = 0.8, bw = 3
  ) + 
  geom_density_line(aes(fill = partner), color = "transparent", bw = 3, alpha = 0.6) +
  geom_vline(data = first_ecdc, aes(xintercept = date, linetype = "first confirmed case to ECDC")) +
  geom_vline(data = first_country %>% group_by(deme) %>% summarise(median = median(date)), aes(xintercept = median, linetype = "first case median infered date")) +
  facet_grid(rows = vars(deme), switch = "y", drop = FALSE, labeller = labeller(deme = facet_names)) +
  scale_fill_manual(name = "source country", values = dcolors, na.value = "grey") +
  scale_x_date(#limits = c(ymd("2020-01-01"), ymd("2020-02-15")), 
    date_breaks = "1 week", date_labels = "%b %d, %Y", expand = c(0,0)) +
  scale_linetype_manual(name = "", values = c(1,2)) +
  ylab("probability density by destination country") +
  xlab("date") +
  labs(title = "First SARS-CoV-2 case in the country") +
  theme(#legend.position = "none",
    legend.key.size = unit(0.5, "cm"),
    axis.title.x=element_blank()) +
  guides(fill = guide_legend(nrow = 1))

# 2.2b First 10 introductions into each country, distribution density destination
m = 10
first_10country <- df_traj %>%
  # 1. Prepare data
  filter(var == "IM", !is.na(partner),  value != 0) %>%
  group_by(traj, deme) %>%
  arrange(date, partner) %>%
  slice(1:m)

first_10countryplot <- ggplot(first_10country, aes(x = date, y = ..count../(m*args$n))) +
  geom_density_line(
    data = select(first_10country, -deme), aes(fill = NA),
    color = "transparent", alpha = 0.8, bw = 3
  ) + 
  geom_density_line(aes(fill = partner), color = "transparent", bw = 3, alpha = 0.6) +
  geom_vline(data = first_ecdc, aes(xintercept = date, linetype = "first confirmed case to ECDC")) +
  #geom_vline(data = first_10country %>% group_by(deme) %>% summarise(median = median(date)), aes(xintercept = median, linetype = "first 10 imported cases median date")) +
  facet_grid(rows = vars(deme), switch = "y", drop = FALSE, labeller = labeller(deme = facet_names)) +
  scale_fill_manual(name = "source country", values = dcolors, na.value = "grey") +
  scale_x_date(#limits = c(ymd("2020-01-01"), ymd("2020-02-15")), 
    date_breaks = "1 week", date_labels = "%b %d, %Y", expand = c(0,0)) +
  scale_linetype_manual(name = "", values = 2) +
  ylab("probability density by destination country") +
  xlab("date") +
  labs(title = "First 10 imported cases to the country") +
  theme(#legend.position = "none",
    legend.key.size = unit(0.5, "cm"),
    axis.title.x=element_blank()) +
  guides(fill = guide_legend(nrow = 1))

first_countryds <- ggarrange(first_countryplot, first_10countryplot, labels = chartr("123456789", "ABCDEFGHI", 1:2), font.label = list(size = 9), nrow = 1, ncol = 2, hjust = -6, vjust = 2, common.legend = TRUE, legend = "bottom")
first_countryds

ggexport(first_countryds,
         filename = paste0(args$output_figure, "03.png"),
         width = 2500, height = 1700, res = 300)
```

## First introductions to each country, source

::: {.columns}

:::: {.column width="50%"}
\small
```{r first-country-table1}
knitr::kable(first_country %>%
               group_by(deme) %>%
               summarise(m = median(date),
                         l = quantile(date, 0.025, type = 1),
                         h = quantile(date, 0.925, type = 1)))
```
::::
  
:::: {.column width="50%"}
\small
```{r first-country-table2}

knitr::kable(first_country %>%
               ungroup %>%
               group_by(deme) %>%
               count(partner, name = "n_1s") %>%
               mutate(p_1s = n_1s/args$n))
```

::::

:::

## First introductions to each country, source

::: {.columns}

:::: {.column width="50%"}
\small
```{r first-country-table3}
knitr::kable((first_10country %>%
                ungroup %>%
                group_by(deme) %>%
                count(partner, name = "n_10s") %>%
                mutate(p_10s = n_10s/(10 * args$n)))[1:15,])
```
::::
  
:::: {.column width="50%"}
\small
```{r first-country-table4}
knitr::kable((first_10country %>%
                ungroup %>%
                group_by(deme) %>%
                count(partner, name = "n_10s") %>%
                mutate(p_10s = n_10s/(10 * args$n)))[16:30,])
```

::::
  
:::


```{r first-times, fig.height=4, include=FALSE}
# 2. First introduction distribution density by deme and time of first official reported case to ECDC
first_times <- df_traj_cases %>%
  # 1. Prepare data
  filter(var == "IM" | var == "O", value != 0) %>%
  group_by(deme, traj) %>%
  arrange(date) %>%
  slice(1) %>%
  ungroup %>%
  bind_rows(df_traj_cases %>%
              filter(var == "IM", value != 0) %>%
              group_by(traj) %>%
              arrange(date) %>%
              slice(1)  %>%
              mutate(deme = "Europe")) %>%
  mutate(deme = fct_rev(deme)) %>%
  # 2. Plot
  ggplot() +
  geom_density_ridges(aes(x = date, y = deme, fill = deme), color = "grey50", quantile_lines = TRUE, quantiles = c(0.025, 0.5, 0.975), bandwidth=2, alpha = 0.7, size = 0.2) +
  #stat_density_ridges(, alpha = 0.7)
  #geom_histogram(aes(x = date, fill = deme), bandwidth=5, alpha = 0.7, size = 0.2) +
  #geom_vline(aes(xintercept = min_date, color = dest), linetype = 2) +
  geom_point(data = first_ecdc, 
             aes(date, deme, fill = deme), color = "grey50", shape = 23, size = 3) +
  scale_fill_manual(values = c(dcolors, "Europe" = "grey")) +
  scale_color_manual(values = c(dcolors, "Europe" = "grey")) +
  scale_x_date(limits = c(ymd("2019-10-01"), ymd("2020-03-08")), date_breaks = "1 month", date_labels = "%b %Y", expand = c(0,0)) +
  scale_y_discrete(expand = c(0.05,0), "probability") +
  #theme_ridges() +
  theme(legend.position = "none",
        axis.title.x=element_blank(),
        panel.grid.major.x =  element_line(colour = "grey80", size = 0.3, linetype = 2),
        panel.grid.major.y =  element_line(colour = "grey80", size = 0.3, linetype = 1),
        #panel.grid.minor.x =  element_line(colour = "grey80", size = 0.2,  linetype = 3),
        #axis.title.y=element_blank(),
        panel.background = element_rect(fill = "white", colour = "white"))

first_times

```

## Events timing

```{r events-timing, fig.height=4}
df_eventsttiming <- df_traj_cases %>%
  filter(var %in% c("O", "B", "D", "IM", "OM"), value != 0, is.na(partner)) %>%
  group_by(traj, var, deme, partner) %>%
  mutate(var = ifelse(var == "O", "B", var)) %>%
  arrange(date) %>%
  slice(1) #%>%
# ungroup(traj) %>%
# summarise(m = median(date),
#           l = quantile(date, 0.025, type = 1),
#           h = quantile(date, 0.925, type = 1)) 

events_timingplot <- ggplot(df_eventsttiming) +
  geom_density_ridges(aes(x = date, y = factor(var, level =  c("OM", "IM", "D", "B")), fill = var), color = "transparent", quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth=2, alpha = 0.7, size = 0.2) + 
  geom_vline(data = first_ecdc, aes(xintercept = date, linetype = "first confirmed case to ECDC")) +
  scale_linetype_manual(values = 2, name = "") +
  facet_wrap(~deme) +
  scale_fill_viridis_d(guide = FALSE) +
  scale_y_discrete(breaks = c("B", "D", "IM", "OM"), labels = c("first local case", "first death/recovered/isolated", "first imported case", "first exported case")) + 
  scale_x_date(#limits = c(ymd("2020-01-01"), ymd("2020-02-15")), 
    date_breaks = "1 month", date_labels = "%b, %Y", expand = c(0,0)) +
  ylab("") +
  xlab("")

events_timingplot
ggexport(events_timingplot,
         filename = paste0(args$output_figure, "04.png"),
         width = 2000, height = 1200, res = 300)

```


## Events timing

::: {.columns}

:::: {.column width="50%"}
\small
```{r events-timing-table1}
knitr::kable((df_eventsttiming %>%
                group_by(deme, var) %>%
                summarise(m = median(date),
                          l = quantile(date, 0.025, type = 1),
                          h = quantile(date, 0.925, type = 1)))[1:12,])
```
::::
  
:::: {.column width="50%"}
\small
```{r events-timing-table2}
knitr::kable((df_eventsttiming %>%
                group_by(deme, var) %>%
                summarise(m = median(date),
                          l = quantile(date, 0.025, type = 1),
                          h = quantile(date, 0.925, type = 1)))[12:24,])
```

::::
  
:::
  
## Summarised epidemic trajectories

```{r trajs ribbon, fig.height = 4}
# 1.1 Median and 95% CCI by deme in log scale
gribbon <- ggplot(traj_summary %>% filter(var == "active_pop")) +
  geom_ribbon(aes(date, ymin = l95_cumvalue, ymax = h95_cumvalue, fill = deme), alpha = 0.5) +
  geom_line(aes(date, median_cumvalue, colour = deme)) +
  ylab("active SARS-CoV-2 infections") +
  #xlab("Date") +
  #labs(title = "SARS-CoV-2 early epidemics in Europe and Hubei",
  #subtitle = "Case trajectories Median and 95% CCI by deme") +
  scale_y_log10(labels = trans_format("log10", math_format(10^.x))) +
  scale_x_date(limits = c(ymd("2019-10-01"), ymd(MRS)), date_breaks = "1 month", date_labels = "%b, %Y", expand = c(0,0)) +
  scale_fill_manual(name = "", values = dcolors) +
  scale_color_manual(name = "", values = dcolors) +
  theme(legend.position = c(0.2, 0.7),
        legend.box="horizontal",
        axis.title.x=element_blank())

gribbon

ggexport(gribbon,
         filename = paste0(args$output_figure, "05.png"),
         width = 1500, height = 1000, res = 300)
```


```{r trajs}
# 1.2 All trajectories single deme in log scale with reported cases date
trajs <- lapply(demes$deme, function(d) {
  df_traj_cases%>%
    # 1. Prepare data
    filter(deme == d, 
           var %in% c("D", "ecdc"), 
           is.na(partner)) %>%
    # 2. Plot
    ggplot() +
    geom_line(aes(date, cumvalue, group = traj,
                  color = var == "ecdc",
                  alpha = var == "ecdc",
                  linetype = var == "ecdc",
                  size = var == "ecdc")) +
    scale_color_manual(name = "",
                       labels = c(paste0(d, " inferred\n population trajectories"),
                                  paste0(ifelse(d == china_deme, "China", as.character(d)),
                                         " total reported cases")),
                       values = c(dcolors[[d]], dark_dcolors[[d]])) +
    scale_alpha_manual(name = "", values = c(0.1, 1), guide = FALSE) +
    scale_linetype_manual(name = "", values = c(1, 5),
                          labels = c(paste0(d, " inferred\n population trajectories"),
                                     paste0(ifelse(d == china_deme, "China", as.character(d)),
                                            " total reported cases"))) +
    scale_size_manual(name = "", values = c(0.2, 1.5),
                      labels = c(paste0(d, " inferred\n population trajectories"),
                                 paste0(ifelse(d == china_deme, "China", as.character(d)),
                                        " total reported cases"))) +
    scale_x_date(limits = c(ymd("2019-10-01"), ymd(MRS)), date_breaks = "1 month", date_labels = "%b, %Y", expand = c(0,0)) +
    scale_y_log10(limits= c(1,10^7.5), expand = c(0, 0),labels = trans_format("log10", math_format(10^.x))) +
    labs(title = d) +
    ylab(ifelse(d %in% c("China", "Germany", "Other European"), "SARS-CoV-2 cases", "")) +
    theme(axis.title.x=element_blank(),
          legend.position = "none",
          legend.box="horizontal",
          panel.grid.major.y =  element_line(colour = "grey80", size = 0.3, linetype = 2),
          panel.grid.minor.y =  element_line(colour = "grey80", size = 0.2,  linetype = 3),
          panel.background =  element_blank(),
          axis.text.x = element_text(size = 8),
          axis.text.y = element_text(size = 10)) 
})

names(trajs) <- demes$deme
ggexport(ggarrange(plotlist = trajs, labels = chartr("123456789", "ABCDEFGHI", 1:length(trajs)), nrow = 3, ncol = 2),
         filename = paste0(args$output_figure, "06.png"),
         width = 2300, height = 3000, res = 300)
```


\tiny
```{r trajs-plotv2, results='asis', fig.height = 4}
for (d in demes$deme) {
  cat("\n## Inferred case counts - ", d, "\n")
  grid.arrange(trajs[[d]], tableGrob(traj_total %>% filter(deme == d, var == "D") %>% t, theme = ttheme_minimal()), ncol = 2, widths = c(2,1))
  cat("\n")
}
```


## Weekly confirmed cases proportion

```{r report-prop, fig.height=4}
df_report <- traj_summary %>%
  filter(var %in% c("D"), deme != "China") %>%
  left_join(case_data %>% filter(source == "ecdc")) %>%
  select(deme, date, l95_value, h95_value, median_value, new_confirmed) %>%
  group_by(deme, year_week = ceiling_date(date, "1 week")) %>%
  summarise(l95_value = sum(l95_value),
            h95_value = sum(h95_value),
            median_value = sum(median_value),
            new_confirmed = sum(new_confirmed)) %>%
  mutate(median_report = new_confirmed/median_value,
         h95_report = new_confirmed/l95_value,
         l95_report = new_confirmed/h95_value)

report_plot <- ggplot(df_report) +
  geom_line(aes(x = year_week, y = median_report, color = deme), stat="identity") +
  geom_point(aes(x = year_week, y = median_report, color = deme), stat="identity") +
  geom_ribbon(aes(year_week, ymin = l95_report, ymax = h95_report,fill = deme), alpha = 0.1) +
  ylab("weekly reporting proportion") +
  scale_color_manual(values = dcolors, name = "") +
  scale_fill_manual(values = dcolors, name = "") +
  scale_x_date(date_breaks = "5 days", date_labels = "%b %d", limits=c(ymd("2020-01-30"), ymd("2020-03-08"))) +
  #scale_x_date(limits = c(ymd("2019-10-01"), ymd(MRS)), date_breaks = "1 month", date_labels = "%b %y") +
  coord_cartesian(ylim = c(0,1)) +
  theme(#legend.position = "none", 
    axis.title.x=element_blank()) #+
#facet_wrap(~deme, scales = "free")

report_plot
ggexport(report_plot,
         filename = paste0(args$output_figure, "07.png"),
         width = 2000, height = 1200, res = 300)
```

\small
```{r report-prop-table}
knitr::kable(traj_summary %>%
               filter(var %in% c("D")) %>%
               left_join(case_data %>% filter(source == "ecdc")) %>%
               select(deme, date, l95_cumvalue, h95_cumvalue, median_cumvalue, total_confirmed) %>%
               group_by(deme) %>%
               filter(date == max(date)) %>%
               mutate(median_report = total_confirmed/median_cumvalue,
                      h95_report = total_confirmed/l95_cumvalue,
                      l95_report = total_confirmed/h95_cumvalue))
```


## Local transmission vs imported cases

```{r bvsm, fig.height=4}
h = df_traj %>%
  filter(var %in% c("B", "IM"), is.na(partner)) %>%
  select(-cumvalue) %>%
  group_by(deme, traj) %>%
  pivot_wider(names_from = "var", values_from = "value") %>%
  filter(IM != 0) %>%
  #na_if(0) %>% replace_na(list(B = 1e-8)) %>%
  mutate(R = B/IM) %>%
  mutate(R = ifelse(R == Inf, NA, R)) %>%
  select(traj, deme, date, R) %>%
  arrange(date) #%>%
#pivot_wider(names_from = date, values_from = R) %>%
#arrange(traj)

inpop = df_traj %>% filter(var == "in_pop", date == "2020-03-07") %>% select(traj, cumvalue)

hweek = df_traj %>%
  filter(var %in% c("B", "IM"), is.na(partner)) %>%
  select(-cumvalue) %>%
  group_by(deme, traj, var, year_week = ceiling_date(date, "1 week")) %>%
  summarize(value = sum(value)) %>%
  pivot_wider(names_from = "var", values_from = "value") %>%
  filter(IM != 0) %>%
  #na_if(0) %>% replace_na(list(B = 1e-8)) %>%
  mutate(R = B/IM) %>%
  mutate(R = ifelse(R == Inf, NA, R)) %>%
  select(traj, deme, year_week, R) %>%
  arrange(year_week) 


hsummary = hweek %>% group_by(deme, year_week) %>% 
  summarise(mR = median(R),
            lR  = HDInterval::hdi(R)[[1]],
            hR  = HDInterval::hdi(R)[[2]])


ratio_plots <- lapply(demes$deme, function(d){
  hweek %>% left_join(inpop) %>% filter(deme == d) %>%
    ggplot() +
    geom_line(aes(year_week, R, group=traj, color = log(cumvalue)), alpha = 0.5) +
    geom_line(data = hsummary %>% filter(deme == d),aes(year_week, mR), size = 1) +
    geom_vline(aes(xintercept=ymd("2020-01-23")), linetype = "dashed") +
    geom_vline(aes(xintercept=ymd("2020-03-01")), linetype = "dashed") +
    #facet_wrap(~deme, scales = "free") +
    coord_cartesian(ylim = c(0,200)) +
    xlab("") +
    ylab(ifelse(d %in% c("China", "Italy"), "ratio local/imported\nnew cases by week", "")) +
    labs(title = d) +
    #scale_colour_gradient(low = "yellow", high = "red", na.value = NA)
    scale_x_date(date_labels = "%b %d, %Y") +
    scale_colour_viridis_c(name = "log cases", direction = -1) +
    theme(legend.position = c(0.2, 0.8),
          legend.key.size = unit(0.2, "cm"),
          title = element_text(size = 10))
})

ratiobm = ggarrange(plotlist = ratio_plots, nrow = 2, ncol = 3)

ratiobm
ggexport(ratiobm,
         filename = paste0(args$output_figure, "08.png"),
         width = 2000, height = 1200, res = 300)
```


```{r bvsm-table, results = 'asis'}
for (d in demes$deme) {
  cat("\n## Local transmission vs imported cases - ", d, "\n")
  print(hsummary %>% filter(deme == d))
  cat("\n")
}
```


```{r circoplot}
plot_chord <- function(df, min_date, max_date) {
  df <- df %>%
    filter(date > min_date, date <= max_date, var == "IM", !is.na(partner)) %>%
    group_by(partner, deme, traj) %>%
    # Take mean value over all trajectories
    summarise(N = sum(value), .groups = "drop_last") %>%
    #summarise(Nm = median(N)/as.numeric(max_date - min_date), .groups = "drop") %>%
    summarise(Nm = median(N), .groups = "drop") %>%
    drop_na()
  
  # parameters
  cplot <- circos.clear()
  cplot <- circos.par(start.degree = 90, gap.degree = 4, track.margin = c(-0.3, 0.3), 
                      points.overflow.warning = FALSE)
  par(mar = rep(0.5, 4))
  # Base plot
  chordDiagram(
    x = df, 
    grid.col = dcolors,
    transparency = 0.25,
    directional = 1,
    direction.type = c("arrows", "diffHeight"), 
    diffHeight  = -0.04,
    annotationTrack = "grid", 
    #annotationTrackHeight = c(0.05, 0.1),
    link.arr.type = "big.arrow", 
    link.sort = TRUE, 
    link.largest.ontop = TRUE)
  # Add text and axis
  circos.trackPlotRegion(
    track.index = 1, 
    bg.border = NA, 
    panel.fun = function(x, y) {
      xlim = get.cell.meta.data("xlim")
      sector.index = get.cell.meta.data("sector.index")
      # Add names to the sector. 
      circos.text(
        x = mean(xlim), 
        y = 3.2, 
        labels = sector.index, 
        facing = "bending", 
        cex = 0.8
      )
      # Add graduation on axis
      circos.axis(
        h = "top", 
        major.at = seq(from = 0, to = xlim[2], by =
                         case_when(
                           xlim[2] > 50500 ~ 20000,
                           xlim[2] > 20500 ~ 20000,
                           xlim[2] > 10500 ~ 5000,
                           #xlim[2] > 5500 ~ 5000,
                           xlim[2] > 2500 ~ 2000,
                           xlim[2] > 2000 ~ 2000,
                           xlim[2] > 1500 ~ 1000,
                           xlim[2] > 800 ~ 500,
                           xlim[2] > 500 ~ 250,
                           xlim[2] > 200 ~ 100,
                           xlim[2] > 100 ~ 50,
                           xlim[2] > 50 ~ 25,
                           xlim[2] > 20 ~ 15,
                           xlim[2] > 10 ~ 10,
                           xlim[2] > 1 ~ 1,
                           round(xlim[2]) == 0 ~ 0.25,
                           TRUE ~ round(xlim[2])/4)),
        minor.ticks = 1, 
        major.tick.length = 0.5,
        labels.niceFacing = FALSE,
        labels.cex = 0.7)
    }
  )
  return(list(df = df, cplot = cplot))
}



```

## Migrations - Period 1

::: {.columns}

:::: {.column width="50%"}
```{r mig1, fig.height=2.5, fig.align='center'}
# Period 1
mig1 <- plot_chord(df_traj, ymd("2019-09-01"), ymd("2020-01-23")) 

png(paste0(args$output_figure, "09a.png"), width = 1000, height = 1000, res = 200)
plot_chord(df_traj, ymd("2019-09-01"), ymd("2020-01-23")) 
text(label = "A", x = -1, y = 1, cex = 1.5, font = 2)
text("Period 1: origin - January 22, 2020", x = 0, y = 1, cex = 0.8, font = 2)
dev.off()
```
::::
  
:::: {.column width="50%"}
\small
```{r mig1-table1}
knitr::kable(mig1$df %>% filter(Nm != 0))
```

::::
  
:::

## Migrations - Period 2

::: {.columns}

:::: {.column width="50%"}
```{r mig2, fig.height=2.5, fig.align='center'}
# Period 2
mig2 <- plot_chord(df_traj, ymd("2020-01-23"), ymd("2020-02-28"))

png(paste0(args$output_figure, "09b.png"), width = 1000, height = 1000, res = 200)
plot_chord(df_traj, ymd("2020-01-23"), ymd("2020-02-28"))
text(label = "B", x = -1, y = 1, cex = 1.5, font = 2)
text("Period 2: January 23, 2020 - February 29, 2020", x = 0, y = 1, cex = 0.8, font = 2)
#dev.off()
```
::::
  
:::: {.column width="50%"}
\tiny
```{r mig2-table1}
knitr::kable(mig2$df %>% filter(Nm != 0))
```

::::

:::

## Migrations - Period 3

::: {.columns}

:::: {.column width="50%"}

```{r mig3, fig.height=2.5, fig.align='center'}
# Period 3
mig3 <- plot_chord(df_traj, ymd("2020-02-28"), ymd("2020-03-08"))

png(paste0(args$output_figure, "09c.png"), width = 1000, height = 1000, res = 200)
plot_chord(df_traj, ymd("2020-02-28"), ymd("2020-03-08"))
text(label = "C", x = -1, y = 1, cex = 1.5, font = 2)
text("Period 3: March 1, 2020 - March 8, 2020", x = 0, y = 1, cex = 0.8, font = 2)
text("total number of exported-imported cases", x = 0.3, y = -1, cex = 0.8, font = 1)
dev.off()
```
::::
  
:::: {.column width="50%"}
\tiny
```{r mig3-table1}
knitr::kable(mig3$df %>% filter(Nm != 0))
```

::::
  
:::


## Daily flight passengers vs daily imported cases

```{r flight-cases, fig.height=4}
demes1 <- c(China = "CN", France = "FR", Germany = "DE", Italy = "IT", OtherEuropean = "OE", Spain = "ES")
flight_df <- get_flightData(countries = demes1) 

demes2 <- setNames(names(demes1), demes1)
flight_df_3e <- flight_df %>%
  filter((month(time) %in% 1:3 & year(time) == 2020) | (month(time) == 12 & year(time) == 2019)) %>%
  mutate(epoch = case_when(
    month(time) == 2 ~ 2,
    month(time) == 3 ~ 3,
    TRUE ~ 1),
    pred = 1) %>%
  rename(src = geo, dest = partner) %>%
  group_by(src, dest, epoch, pred) %>%
  summarise(N = n(),
            values = sum(dvalues/N)) %>%
  ungroup %>%
  select(epoch, src, dest, values) %>%
  mutate(src = demes2[src], dest = demes2[dest])

by_epoch = df_traj %>%
  filter(var == "IM", cumvalue != 0, !is.na(partner)) %>%
  mutate(epoch = case_when(
    month(date) == 2 ~ 2,
    month(date) == 3 ~ 3,
    TRUE ~ 1)) %>%
  rename(src = partner, dest = deme) %>%
  group_by(src, dest, epoch, traj) %>%
  summarise(N = n(),
            evalues = sum(value)/N) %>%
  #mutate(evalues = value) %>%
  select(traj, epoch, src, dest, evalues) 

df_f = left_join(by_epoch, flight_df_3e) %>%
  group_by(src, dest, epoch) %>%
  summarise(v = median(values),
            ev = median(evalues),
            lev = HDInterval::hdi(evalues)[[1]],
            hev = HDInterval::hdi(evalues)[[2]])

imflights <- ggplot(df_f, aes(ev, v, group=interaction(src, dest))) +
  #geom_line(aes(color = src)) + 
  geom_line(color = "grey80", size = 1) +
  geom_pointrange(shape = 21, size = 0.4, linetype = 1, alpha = 0.7, aes(x = ev, y = v, xmin = lev, xmax = hev, fill=factor(epoch), color=factor(epoch))) +
  scale_y_log10(labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(labels = trans_format("log10", math_format(10^.x))) +
  ylab("daily flight passengers") +
  xlab("daily imported cases") +
  facet_grid(~dest) +
  scale_color_viridis_d(labels=c("period 1", "period 2", "period 3")) +
  scale_fill_viridis_d(labels=c("period 1", "period 2", "period 3")) +
  ggrepel::geom_text_repel(
    data = df_f %>% filter(epoch == 3),
    aes(ev, v, label = demes1[src]),
    segment.alpha = 0, point.padding = 0.25,
    #segment.size = 5,
    #box.padding = .5,
    force = 1,
    size = 8/.pt,
    nudge_x = 1,
    #nudge_y = 0.5,
    color = "grey30"
  ) +
  theme(panel.grid.major.y =  element_line(colour = "grey80", size = 0.2, linetype = 3),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_text(size = 8),
        panel.grid.major.x =  element_line(colour = "grey80", size = 0.2,  linetype = 3),
        #legend.position = c(0.8, 0.1),
        legend.position = "bottom",
        legend.background = element_rect(fill = "white", size=0.1, linetype="solid", 
                                         colour ="white"),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.key.size = unit(0.4, "cm"),
        legend.spacing = unit(0.4, "mm"),
        legend.direction = "horizontal",
        legend.box.margin = margin(c(0,0,0,0)),
        legend.margin = margin(c(0,0,0,0)),
        panel.background = element_rect(fill = "white", colour = "grey80"))
imflights
ggexport(imflights,
         filename = paste0(args$output_figure, "10.png"),
         width = 2000, height = 1200, res = 300)
```


## Daily flight passengers vs daily imported cases
\tiny
```{r flight-cases-table}
knitr::kable(left_join(by_epoch, flight_df_3e) %>%
               group_by(dest, epoch, src) %>%
               summarise(v = median(values),
                         ev = median(evalues),
                         lev = HDInterval::hdi(evalues)[[1]],
                         hev = HDInterval::hdi(evalues)[[2]], .groups = "drop_last") %>%
               summarise(v = sum(v),
                         ev = sum(ev),
                         lev = sum(lev),
                         hev = sum(hev)))
```


## Weekly incidence population

```{r incidence, fig.height=4}
library(wpp2019)
data(pop)
pop <- pop %>% filter(name %in% demes$deme) %>% rename(deme = name) %>% mutate(population = `2020` * 1000) %>% select(deme, population)

df_inc <- traj_summary %>%
  filter(var %in% c("D")) %>%
  left_join(pop) %>%
  select(deme, date, l95_cumvalue, h95_cumvalue, median_cumvalue, population) %>%
  group_by(deme, population, date) %>%
  summarise(l95_cumvalue = sum(l95_cumvalue),
            h95_cumvalue = sum(h95_cumvalue),
            median_cumvalue = sum(median_cumvalue)) %>%
  mutate(median_inc = median_cumvalue/population  * 100,
         h95_inc = l95_cumvalue/population  * 100,
         l95_inc = h95_cumvalue/population  * 100)

inc_plot <- ggplot(df_inc) +
  geom_line(aes(x = date, y = median_inc, color = deme), stat="identity") +
  geom_point(aes(x = date, y = median_inc, color = deme), stat="identity") +
  geom_ribbon(aes(date, ymin = l95_inc, ymax = h95_inc,fill = deme), alpha = 0.1) +
  ylab("weekly incidence %") +
  scale_color_manual(values = dcolors, name = "") +
  scale_fill_manual(values = dcolors, name = "") +
  scale_x_date(date_breaks = "5 days", date_labels = "%b %d", limits=c(ymd("2020-01-30"), ymd("2020-03-08"))) +
  #scale_x_date(limits = c(ymd("2019-10-01"), ymd(MRS)), date_breaks = "1 month", date_labels = "%b %y") +
  #coord_cartesian(ylim = c(0,1)) +
  theme(#legend.position = "none", 
    axis.title.x=element_blank()) #+
inc_plot

ggexport(inc_plot,
         filename = paste0(args$output_figure, "11.png"),
         width = 2000, height = 1200, res = 300)
```

## Weekly incidence population percentage

\small
```{r incidence-table}
knitr::kable(df_inc %>% filter(date == max(date)))
```
